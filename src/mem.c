#include <common.h>
#include <mem.h>

uint8_t mem[MEMSIZE] = {
    // default program which will print "Hello, CSE!"
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x48, 0x00, // addi a1 zr 'H'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x65, 0x00, // addi a1 zr 'e'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x6c, 0x00, // addi a1 zr 'l'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x6c, 0x00, // addi a1 zr 'l'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x6f, 0x00, // addi a1 zr 'o'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x2c, 0x00, // addi a1 zr ','
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x43, 0x00, // addi a1 zr 'C'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x53, 0x00, // addi a1 zr 'S'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x45, 0x00, // addi a1 zr 'E'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x21, 0x00, // addi a1 zr '!'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x02, 0x00, // addi a0 zr 1
    0xd0, 0x01, 0x0a, 0x00, // addi a1 zr '\n'
    0x1e, 0x00, 0x00, 0x00, // scall
    0x90, 0x01, 0x00, 0x00, // addi a0 zr 0
    0xd0, 0x01, 0x00, 0x00, // addi a1 zr 0
    0x1e, 0x00, 0x00, 0x00, // scall
};

long load_prog(char *file) {
    if (file == NULL) return 92; // the size of default prog
    FILE *fp = fopen(file, "rb");
    assert(fp != NULL);

    fseek(fp, 0, SEEK_END);
    long size = ftell(fp);

    fseek(fp, 0, SEEK_SET);
    int ret = fread(mem, size, 1, fp);
    assert(ret == 1);

    fclose(fp);
    return size;
}

bool in_mem(uint32_t addr) {
    return addr >= 0 && addr < MEMSIZE;
}

uint32_t mem_read(uint32_t addr) {
    if (in_mem(addr)) {
        uint32_t data = *(uint32_t *)(mem + addr);
        // printf("mem[%#010x] %#010x\n", addr, data);
        return data;
    }
    printf("0x%08x\n", addr);
    assert(0);
}

void mem_write(uint32_t addr, uint32_t data) {
    if (in_mem(addr)) *(uint32_t *)(mem + addr) = data; return;
    assert(0);
}
